#!/bin/bash

# Install Homebrew
if [ ! "$(which brew)" ]; then
  /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

# Sudo without password
sudo sed -i '' 's/^%admin.*/%admin          ALL = (ALL) NOPASSWD:ALL/' /etc/sudoers

CASKS=$(brew cask ls)
FORMULAE=$(brew ls)

function has_cask () {
  echo "${CASKS}" | grep --quiet --line-regexp --fixed-strings "$1"
}

function has_formula () {
  echo "${FORMULAE}" | grep --quiet --line-regexp --fixed-strings "$1"
}

function cask_install () {
  for cask in "$@"; do
    printf "Installing cask $cask..."
    has_cask "$cask" || {
      brew cask install $cask
      APP=`brew cask info $cask | grep \(App\) | cut -f1 -d'.'`
      test ! -z "$APP" && xattr -dr com.apple.quarantine "/Applications/$APP.app"
    }
    echo ✔︎
  done
}

function brew_install () {
  for formula in "$@"; do
    printf "Installing $formula..."
    has_formula "$formula" || brew install $formula
    echo ✔︎
  done
}

function composer_install () {
  for package in "$@"; do
    printf "Installing composer package $package..."
    test -d ~/.composer/vendor/$package || composer global require $package
    echo ✔︎
  done
}

# Programming languages
brew_install ruby python node yarn rust go

# Erlang & Elixir
has_formula elixir || {
  brew_install erlang elixir
  mix local.hex --force
  mix local.rebar --force
}

# PHP, Composer, Laravel
brew_install php composer
composer_install laravel/installer
test -f ~/.composer/vendor/bin/valet || {
  composer_install laravel/valet
  valet install
  mkdir ~/Sites
  cd ~/Sites && valet park
}

# Basic tooling
brew_install wget curl httpie tree git gnupg pgcli asciinema

# Developer tools
cask_install docker rowanj-gitx

# Applications
cask_install whatsapp slack boxcryptor dropbox 1password gnucash keybase

# VSCode
has_cask visual-studio-code || {
  cask_install visual-studio-code
  mkdir -p ~/Library/Application\ Support/Code/User
  for file in settings.json keybindings.json snippets; do
    rm -rf ~/Library/Application\ Support/Code/User/$file
    ln -s ~/.vscode/$file ~/Library/Application\ Support/Code/User
  done
}

# VSCode extensions
code \
    --install-extension nikoskornarakis.predawn-twilight \
    --install-extension mrmlnc.vscode-duplicate \
    --force

# PostgreSQL
has_formula postgresql || {
  brew_install postgresql
  brew services start postgresql
  sleep 2
  createuser -s postgres
}

# Oh-my-zsh
brew_install zsh
if [ ! -d ~/.oh-my-zsh ]; then
  SHELL=zsh sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
  CURRENT_SHELL=$(dscl . -read /Users/$USER UserShell | cut -f 2 -d' ')
  sudo dscl . -change /Users/$USER UserShell $CURRENT_SHELL /usr/local/bin/zsh

  # reset original .zshrc
  git checkout -- .zshrc
fi

# Zsh plugins
for plugin in zsh-syntax-highlighting zsh-autosuggestions; do
  dir=${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/$plugin
  test -d $dir || git clone https://github.com/zsh-users/$plugin.git $dir
done

# Change default shell to ZSh
if [[ "$SHELL" != "/bin/zsh" ]]; then
  chsh -s /bin/zsh
fi

printf "\n\n--== REMEMBER to use: \`sudo trimforce enable\` if using a 3rd-party SSD ==--\n\n"
