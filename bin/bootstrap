#!/bin/bash

# Install Homebrew
if [ ! "$(which brew)" ]; then
  /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

# Sudo without password
sudo sed -i '' 's/^%admin.*/%admin          ALL = (ALL) NOPASSWD:ALL/' /etc/sudoers

CASKS=$(brew cask ls)
FORMULAE=$(brew ls)

function has_cask () {
  echo "${CASKS}" | grep --quiet --line-regexp --fixed-strings "$1"
}

function has_formula () {
  echo "${FORMULAE}" | grep --quiet --line-regexp --fixed-strings "$1"
}

function cask_install () {
  for cask in "$@"; do
    printf "Installing cask $cask..."
    has_cask "$cask" || {
      brew cask install $cask
      APP=`brew cask info $cask | grep \(App\) | cut -f1 -d'.'`
      test ! -z "$APP" && xattr -dr com.apple.quarantine "/Applications/$APP.app"
    }
    echo ✔︎
  done
}

function brew_install () {
  for formula in "$@"; do
    printf "Installing $formula..."
    has_formula "$formula" || brew install $formula
    echo ✔︎
  done
}

# Programming languages
brew_install ruby python node yarn rust golang

# Erlang & Elixir
has_formula elixir || {
  brew_install erlang elixir
  mix local.hex --force
  mix local.rebar --force
}

# Basic tooling
brew_install wget curl httpie tree git gnupg pgcli asciinema

# Developer tools
cask_install docker rowanj-gitx

# Applications
cask_install whatsapp slack boxcryptor dropbox 1password gnucash keybase

# VSCode
has_cask visual-studio-code || {
  cask_install visual-studio-code
  mkdir -p ~/Library/Application\ Support/Code/User
  for file in settings.json keybindings.json snippets; do
    rm -rf ~/Library/Application\ Support/Code/User/$file
    ln -s ~/.vscode/$file ~/Library/Application\ Support/Code/User
  done
}

# PostgreSQL
has_formula postgresql || {
  brew_install postgresql
  brew services start postgresql
  sleep 2
  createuser -s postgres
}

printf "\n\n--== REMEMBER to use: \`sudo trimforce enable\` if using a 3rd-party SSD ==--\n\n"
